import xmltodict
import urllib.parse as urlparse
from urllib.parse import parse_qs
import re

from http_handler.http_handler import HTTPRequest


class WPDetector:

    _ADMIN_PATH = "/wp-admin"
    _LOGIN_PATH = "wp-login.php"
    _FEED_PATH = "/feed"
    _UPGRADE_PATH = _ADMIN_PATH+"/upgrade.php"

    def __init__(self):
        self._http_handler = HTTPRequest()
        self._words_values = {"/wp-content/": 0.8, '<meta name="generator" content="WordPress': 0.8,
                              "/wordpress/": 0.8, "WordPress": 0.2, "wp-emoji-release.min.js": 0.8}
        self._files_needles = {"license.txt": "WordPress - Web publishing software",
                               "readme.html": "Semantic Personal Publishing Platform"}

    def __check_admin_panel(self, url):
        pass

    def __check_admin_panel(self, url):
        admin_path = url + self._ADMIN_PATH
        response = self._http_handler.request(admin_path, "GET")
        if response is not None:
            if "wp-login.php" in str(response):  # if in the response there is "qp-login.php"
                return 1
            else:
                return 0.2  # if not probably not a WP
        else:
            return 0  # not a wardress site

    def __check_words(self, url):
        probability = 0
        response = self._http_handler.request(url, "GET")
        content = str(response)
        for word, value in self._words_values.items():
            if word in content:
                print(word)
                print("hit")
                probability += value
                print(probability)
        return probability

    def __check_files(self, url):
        counter = 0
        for file, needle in self._files_needles.items():
            assembled_url = url+'/'+file
            response = self._http_handler.request(assembled_url, "GET")
            content = str(response)
            if needle in content:
                counter += 1

        return counter/len(self._files_needles.keys())

    def find_version(self, url):
        version = self.__find_version_in_source(url)
        if version is not None:
            return version
        version = self.__find_version_in_feed(url + self._FEED_PATH)
        if version is not None:
            return version
        version = self.__find_version_in_source(url + self._UPGRADE_PATH)
        if version is None:
            version = "Unknow"
        return version

    def __find_version_in_feed(self, url):
        response = self._http_handler.request(url, "GET")  # get the page

        if response is None:
            return None
        try:
            page = xmltodict.parse(response)  # page => to xml
            ver_url = page["rss"]["channel"]["generator"]  # get the generator var
            ver_url = urlparse.urlparse(ver_url)  # extract the v parameter
            version = parse_qs(ver_url.query)['v'][0]
            return version
        except:
            return None

    def __find_version_in_source(self, url):
        css_path = ["/style-rtl.min.css?ver=", "/style.min.css?ver=", "/wp-emoji-release.min.js?ver=",
                    "/install.min.css?ver=", "/buttons.min.css?ver=", "<meta name=\"generator\" content=\"WordPress "]
        response = self._http_handler.request(url, "GET")
        for i in css_path:
            data = str(response)
            version = data.partition(i)[2].partition("\"")[0]
            if len(version) > 10:
                version = version.split("\\")[0].split("\'")[0]
            elif len(version) > 1:
                return version
            else:
                version = None
        return version

    def __check_if_wp(self, url):
        words_prob = self.__check_words(url)
        files_prob = self.__check_files(url)
        print("result for: **** " + url + "***")
        print("words: " + str(words_prob))
        print("files: " + str(files_prob))
        print("total: " + str((words_prob+files_prob)/2))

        return (words_prob+files_prob)/2

    def detect(self, url, threshold=0.4):
        prob = self.__check_if_wp(url)
        if prob >= threshold:
            return True
        else:
            return False
