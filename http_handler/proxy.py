from itertools import cycle

try:
    from config import logs
except Exception as e:
    if 'logs' in dir():
        logs.save_log("Import Error: {}".format(e))
    print("Import Error: {}".format(e))


class Proxy:

    def __init__(self, proxies=None):
        """
        This class will handle all the proxies we want to maintain
            :param address_pool: pool of addresses
            :param addresses_cycle: addresses cycle - which with we can randomly pick one
            :param proxies:
        """
        self._address_pool = set() if proxies is None else set(proxies)
        self._address_pool_cycle = cycle(self._address_pool)
        self.__load_proxies_from_file()

    def __load_proxies_from_file(self):
        """
        this method loads proxies from the proxies file into the address pool
        """
        proxies_from_file = set()
        try:
            with open("http_handler/proxy_data.csv", 'r', encoding='utf-8') as fd:
                for line in fd:
                    line = line.split(' ')
                    proxies_from_file.add(line[:-1][0])
        except Exception as e:
            logs.save_log("Exception: failed to load proxies at __load_proxies_from_file method, Error: {}".format(e))
            print(str(e))
            return
        finally:
            self._address_pool |= proxies_from_file
            self.__update_cycle()

    def __update_cycle(self):
        self._address_pool_cycle = cycle(self._address_pool)  # updating the cycle

    def convert_url_to_proxy(self, url, port):
        """
        this method converts a url and a port to proxy, adds the address to the pool and returns this specific proxy
        :param url: string of the url or ip
        :param port: string of the desired port
        :return the proxy after conversion
        :rtype dict
        """
        address = "{}:{}".format(url, port)  # converting
        self._address_pool.add(address)  # adding address to pool
        self.__update_cycle()
        proxy = {"http": address, "https": address}
        return proxy

    def add_proxy(self, url, port):
        """
        this method adds new address to the addresses' set
        :param url: string of the url or ip
        :param port: string of the desired port
        """
        address = "{}:{}".format(url, port)
        self._address_pool.add(address)
        self.__update_cycle()

    def remove_proxy(self, url, port):
        """
        this method removes a specific address from the pool
        :param url: string of the url or ip
        :param port: string of the desired port
        """
        address = "{}:{}".format(url, port)
        self._address_pool.remove(address)
        self.__update_cycle()

    def get_proxy(self):
        """
        this method converts random address from the pool to proxy
        :return: random proxy
        :rtype: dict
        """
        address = next(self._address_pool_cycle)  # pick random address
        proxy = {"http": address, "https": address}
        return proxy

    def get_all_proxies(self):
        """
        this method converts all the addresses in the pool to proxies (http & https)
        :return: all the addresses as proxies after conversion
        :rtype: array of dicts (json)
        """
        proxies = []
        for addr in self._address_pool:
            proxy = {"http": addr, "https": addr}
            proxies.append(proxy)
        return proxies
